pipeline {
  agent any
  environment {
    AWS_DEFAULT_REGION = 'ap-south-1'
    PORTFOLIO_STACK    = 'poc-data-portfolio-dev'
    PROVISION_STACK    = 'poc-data-provision-dev'

    // the role we already associated to the portfolio in pipeline 2
    SC_LAUNCH_ROLE_ARN = 'arn:aws:iam::145411222814:role/ServiceCatalogProvisioningRole'
  }
  stages {

    stage('Checkout') {
      steps { checkout scm }
    }

    // 1) make sure core-infra SSM params exist (this still uses base Jenkins creds)
    stage('Pre-flight core (check SSM)') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_default']]) {
          sh '''
          aws ssm get-parameter --name /core/vpc/id >/dev/null
          aws ssm get-parameter --name /core/subnet/private/a >/dev/null
          aws ssm get-parameter --name /core/subnet/public/a >/dev/null
          '''
        }
      }
    }

    // 2) assume the SC launch role → we'll use these creds for *everything* after this
    stage('Assume SC launch role') {
      steps {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: 'aws_default']]) {
          script {
            // ask STS for temporary creds
            def out = sh(
              returnStdout: true,
              script: """
                aws sts assume-role \
                  --role-arn ${SC_LAUNCH_ROLE_ARN} \
                  --role-session-name sc-provision-session \
                  --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' \
                  --output text
              """
            ).trim()

            // out will look like: "AKIA.... secret... token..."
            def parts = out.split("\\s+")
            if (parts.size() < 3) {
              error "Failed to assume role ${SC_LAUNCH_ROLE_ARN}"
            }

            env.ASSUMED_AWS_ACCESS_KEY_ID     = parts[0]
            env.ASSUMED_AWS_SECRET_ACCESS_KEY = parts[1]
            env.ASSUMED_AWS_SESSION_TOKEN     = parts[2]

            echo "✅ Assumed role ${SC_LAUNCH_ROLE_ARN}"
          }
        }
      }
    }

    // 3) read product IDs from portfolio using the ASSUMED creds
    stage('Read product IDs from portfolio') {
      steps {
        // use the assumed credentials for all aws calls in this stage
        withEnv([
          "AWS_ACCESS_KEY_ID=${env.ASSUMED_AWS_ACCESS_KEY_ID}",
          "AWS_SECRET_ACCESS_KEY=${env.ASSUMED_AWS_SECRET_ACCESS_KEY}",
          "AWS_SESSION_TOKEN=${env.ASSUMED_AWS_SESSION_TOKEN}",
          "AWS_DEFAULT_REGION=${env.AWS_DEFAULT_REGION}"
        ]) {
          script {
            env.SNS_ID = sh(returnStdout: true, script: """
              aws cloudformation describe-stacks --stack-name ${PORTFOLIO_STACK} \
                --query "Stacks[0].Outputs[?OutputKey=='SnsProductId'].OutputValue" \
                --output text
            """).trim()

            env.SQS_ID = sh(returnStdout: true, script: """
              aws cloudformation describe-stacks --stack-name ${PORTFOLIO_STACK} \
                --query "Stacks[0].Outputs[?OutputKey=='SqsProductId'].OutputValue" \
                --output text
            """).trim()

            env.LBD_ID = sh(returnStdout: true, script: """
              aws cloudformation describe-stacks --stack-name ${PORTFOLIO_STACK} \
                --query "Stacks[0].Outputs[?OutputKey=='LambdaProductId'].OutputValue" \
                --output text
            """).trim()

            env.GLU_ID = sh(returnStdout: true, script: """
              aws cloudformation describe-stacks --stack-name ${PORTFOLIO_STACK} \
                --query "Stacks[0].Outputs[?OutputKey=='GlueProductId'].OutputValue" \
                --output text
            """).trim()

            env.SFN_ID = sh(returnStdout: true, script: """
              aws cloudformation describe-stacks --stack-name ${PORTFOLIO_STACK} \
                --query "Stacks[0].Outputs[?OutputKey=='StepFnProductId'].OutputValue" \
                --output text
            """).trim()

            env.EVB_ID = sh(returnStdout: true, script: """
              aws cloudformation describe-stacks --stack-name ${PORTFOLIO_STACK} \
                --query "Stacks[0].Outputs[?OutputKey=='EvbProductId'].OutputValue" \
                --output text
            """).trim()

            // fail early if anything is blank
            if (!env.SNS_ID || env.SNS_ID == "None")  error("SNS product id missing from portfolio")
            if (!env.SQS_ID || env.SQS_ID == "None")  error("SQS product id missing from portfolio")
            if (!env.LBD_ID || env.LBD_ID == "None")  error("Lambda product id missing from portfolio")
            if (!env.GLU_ID || env.GLU_ID == "None")  error("Glue product id missing from portfolio")
            if (!env.SFN_ID || env.SFN_ID == "None")  error("StepFn product id missing from portfolio")
            if (!env.EVB_ID || env.EVB_ID == "None")  error("EventBridge product id missing from portfolio")

            echo """
            ✅ Product IDs (from ${PORTFOLIO_STACK}):
              SNS   = ${env.SNS_ID}
              SQS   = ${env.SQS_ID}
              LAMBDA= ${env.LBD_ID}
              GLUE  = ${env.GLU_ID}
              STEP  = ${env.SFN_ID}
              EVB   = ${env.EVB_ID}
            """
          }
        }
      }
    }

    // 4) deploy the provision stack USING the assumed creds
    stage('Deploy provision stack') {
      steps {
        withEnv([
          "AWS_ACCESS_KEY_ID=${env.ASSUMED_AWS_ACCESS_KEY_ID}",
          "AWS_SECRET_ACCESS_KEY=${env.ASSUMED_AWS_SECRET_ACCESS_KEY}",
          "AWS_SESSION_TOKEN=${env.ASSUMED_AWS_SESSION_TOKEN}",
          "AWS_DEFAULT_REGION=${env.AWS_DEFAULT_REGION}"
        ]) {
          sh """
          aws cloudformation deploy \
            --stack-name ${PROVISION_STACK} \
            --template-file cloud/app-provision/stacks/provision-dev.yml \
            --parameter-overrides \
              Env=dev \
              SnsProductId=${SNS_ID} \
              SqsProductId=${SQS_ID} \
              LambdaProductId=${LBD_ID} \
              GlueProductId=${GLU_ID} \
              StepFnProductId=${SFN_ID} \
              EvbProductId=${EVB_ID} \
              ProvisioningArtifactName=v1 \
              CoreVpcParam=/core/vpc/id \
              CorePrivateSubnetParam=/core/subnet/private/a \
              CorePublicSubnetParam=/core/subnet/public/a
          """
        }
      }
    }

    // 5) show outputs (still with assumed creds)
    stage('Show outputs') {
      steps {
        withEnv([
          "AWS_ACCESS_KEY_ID=${env.ASSUMED_AWS_ACCESS_KEY_ID}",
          "AWS_SECRET_ACCESS_KEY=${env.ASSUMED_AWS_SECRET_ACCESS_KEY}",
          "AWS_SESSION_TOKEN=${env.ASSUMED_AWS_SESSION_TOKEN}",
          "AWS_DEFAULT_REGION=${env.AWS_DEFAULT_REGION}"
        ]) {
          sh """
          aws cloudformation describe-stacks \
            --stack-name ${PROVISION_STACK} \
            --query 'Stacks[0].Outputs' \
            --output table
          """
        }
      }
    }
  }
}